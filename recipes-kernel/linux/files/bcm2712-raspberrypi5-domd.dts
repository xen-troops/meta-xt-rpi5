/dts-v1/;

/ {
	#address-cells = <0x2>;
	#size-cells = <0x2>;

	gic: gic {
		#interrupt-cells = <0x3>;
		interrupt-controller;
	};

	passthrough {
		compatible = "raspberrypi,5-model-b", "brcm,bcm2712", "simple-bus";
		ranges;
		#address-cells = <0x2>;
		#size-cells = <0x2>;

		mmc@1000fff000 {
			compatible = "brcm,bcm2712-sdhci";
			interrupt-parent = <&gic>;
			interrupts = <0x0 0x111 0x4>;
			reg-names = "host", "cfg", "busisol", "lcpll";
			reg = <0x10 0xfff000 0x0 0x260 0x10 0xfff400 0x0 0x200
			       0x10 0x15040b0 0x0 0x4 0x10 0x15200f0 0x0 0x24>;
			clocks = <&clk_emmc2>;
			cd-gpios = <&gpio7d517c00 0x5 0x1>;
			sd-uhs-sdr104;
			sd-uhs-ddr50;
			sd-uhs-sdr50;
			bus-width = <0x4>;
			vmmc-supply = <&sd_vcc_reg>;
			vqmmc-supply = <&sd_io_1v8_reg>;
			mmc-ddr-3_3v;
			sdhci-caps = <0x0 0x0>;
			sdhci-caps-mask = <0xc000 0x0>;
			xen,path = "/axi/mmc@fff000";
			xen,force-assign-without-iommu = <0x1>;
			xen,reg = <0x10 0xfff000 0x0 0x1000 0x10 0xfff000 0x10 0x1504000 0x0
				   0x1000 0x10 0x1504000 0x10 0x1520000 0x0 0x1000 0x10 0x1520000>;
			status = "okay";
		};

		clk_emmc2: clk_emmc2 {
			compatible = "fixed-clock";
			#clock-cells = <0x0>;
			clock-output-names = "emmc2-clock";
			clock-frequency = <0xbebc200>;
			extracted,path = "/clocks/clk_emmc2";
		};

		clk_xosc: clk_xosc {
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-output-names = "xosc";
			clock-frequency = <50000000>;
		};

		macb_pclk: macb_pclk {
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-output-names = "pclk";
			clock-frequency = <200000000>;
		};

		macb_hclk: macb_hclk {
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-output-names = "hclk";
			clock-frequency = <200000000>;
		};

		 sd_io_1v8_reg: sd_io_1v8_reg {
			compatible = "regulator-gpio";
			states = <0x1b7740 0x1 0x325aa0 0x0>;
			gpios = <&gpio7d517c00 0x3 0x0>;
			regulator-settling-time-us = <0x1388>;
			regulator-always-on;
			regulator-boot-on;
			regulator-max-microvolt = <0x325aa0>;
			regulator-min-microvolt = <0x1b7740>;
			regulator-name = "vdd-sd-io";
			extracted,path = "/sd_io_1v8_reg";
			status = "okay";
		};

		gpio7d517c00: gpio@107d517c00 {
			compatible = "brcm,brcmstb-gpio";
			#gpio-cells = <0x2>;
			gpio-controller;
			reg = <0x10 0x7d517c00 0x00 0x40>;
			brcm,gpio-direct;
			brcm,gpio-bank-widths = <0x11 0x6>;
			xen,path = "/soc/gpio@7d517c00";
			xen,force-assign-without-iommu = <0x1>;
			xen,reg = <0x10 0x7d517000 0x0 0x1000 0x10 0x7d517000>;
		};

		sd_vcc_reg: sd_vcc_reg {
			compatible = "regulator-fixed";
			gpios = <&gpio7d517c00 0x4 0x0>;
			enable-active-high;
			regulator-boot-on;
			regulator-max-microvolt = <0x325aa0>;
			regulator-min-microvolt = <0x325aa0>;
			regulator-name = "vcc-sd";
			extracted,path = "/sd_vcc_reg";
			status = "okay";
		};

		mip0: msi-controller@1000130000 {
			compatible = "brcm,bcm2712-mip-intc";
			reg = <0x10 0x00130000 0x0 0xc0>;
			interrupt-parent = <&gic>;
			msi-controller;
			interrupt-controller;
			#interrupt-cells = <2>;
			brcm,msi-base-spi = <128>;
			brcm,msi-num-spis = <64>;
			brcm,msi-offset = <0>;
			brcm,msi-pci-addr = <0xff 0xfffff000>;
			xen,path = "/axi/msi-controller@130000";
			xen,force-assign-without-iommu = <0x1>;
			xen,reg = <0x10 0x00130000 0x0 0x1000 0x10 0x00130000>;
			interrupts = <0x00 0x80 0x04 0x00 0x81 0x04 0x00 0x82 0x04
				      0x00 0x83 0x04 0x00 0x84 0x04 0x00 0x85 0x04
				      0x00 0x86 0x04 0x00 0x87 0x04 0x00 0x88 0x04
				      0x00 0x89 0x04 0x00 0x8a 0x04 0x00 0x8b 0x04
				      0x00 0x8c 0x04 0x00 0x8d 0x04 0x00 0x8e 0x04
				      0x00 0x8f 0x04 0x00 0x90 0x04 0x00 0x91 0x04
				      0x00 0x92 0x04 0x00 0x93 0x04 0x00 0x94 0x04
				      0x00 0x95 0x04 0x00 0x96 0x04 0x00 0x97 0x04
				      0x00 0x98 0x04 0x00 0x99 0x04 0x00 0x9a 0x04
				      0x00 0x9b 0x04 0x00 0x9c 0x04 0x00 0x9d 0x04
				      0x00 0x9e 0x04 0x00 0x9f 0x04 0x00 0xa0 0x04>;
		};

		pciex: pcie@1000120000 {
			compatible = "brcm,bcm2712-pcie";
			#address-cells = <0x3>;
			#size-cells = <0x2>;
			#interrupt-cells = <0x1>;
			reg = <0x10 0x120000 0x0 0x9310>;
			aspm-no-l0s;
			brcm,vdm-qos-map = <0xbbaa9888>;
			brcm,enable-mps-rcb;
			brcm,enable-l1ss;
			dma-ranges = <0x2000000 0x0 0x0 0x1f 0x0 0x0 0x400000
				      0x43000000 0x10 0x0 0x0 0x0 0x10 0x0>;
			ranges = <0x2000000 0x0 0x0 0x1f 0x0 0x0 0xfffffffc
				  0x43000000 0x4 0x0 0x1c 0x0 0x3 0x0>;
			interrupt-parent = <&gic>;
			/*
			 * HACK: But the mip0: msi-controller@130000 doesn't have IRQs defined
			 * in the standard way and instead uses custom properties:
			 * brcm,msi-base-spi to define GIC IRQ offset, and brcm,msi-num-spis
			 * to define number of GIC IRQs to use. The Xen doesn't understand this
			 * and so can't map interrupts to DomU in case of 'xen,passthrough'.
			 * The attempt to add correct interrupts property to the mip0:
			 * msi-controller@130000 has failed - no IRQs received by macb
			 * 1f00100000.ethernet. Reason unknown.
			 */
//			msi-parent = <&mip0>;
			msi-parent = <&pciex>;
			msi-controller;
			interrupt-names = "pcie", "msi";
			interrupts = <0x0 0xe9 0x4 0x0 0xea 0x4>;
			interrupt-map-mask = <0x0 0x0 0x0 0x7>;
			interrupt-map = <0x00 0x00 0x00 0x01 &gic 0x00 0xe5 0x04 
					 0x00 0x00 0x00 0x02 &gic 0x00 0xe6 0x04
					 0x00 0x00 0x00 0x03 &gic 0x00 0xe7 0x04
					 0x00 0x00 0x00 0x04 &gic 0x00 0xe8 0x04>;
			reset-names = "swinit", "bridge", "rescal";
			resets = <&reset_controller1504318 0x20>,
				 <&reset_controller1504318 0x2c>,
				 <&reset_controller119500>;
			max-link-speed = <0x2>;
			device_type = "pci";
			xen,path = "/axi/pcie@120000";
			xen,force-assign-without-iommu = <0x1>;
			xen,reg = <0x10 0x120000 0x0 0xA000 0x10 0x120000
				   0x1f 0x00 0x0 0x600000 0x1f 0x00>;
			status = "okay";

			rp1: rp1@c040000000 {
				compatible = "simple-bus";
				#address-cells = <0x2>;
				#size-cells = <0x2>;
				#interrupt-cells = <0x2>;
				interrupt-controller;
				interrupt-parent = <&rp1>;
				dma-ranges = <0x10 0x0 0x43000000 0x10 0x0 0x10
					      0x0 0xc0 0x40000000 0x2000000 0x0
					      0x0 0x0 0x400000 0x0 0x0 0x2000000
					      0x10 0x0 0x10 0x0>;
				ranges = <0xc0 0x40000000 0x2000000 0x0 0x0 0x0 0x400000>;

				ethernet@c040100000 {
					compatible = "cdns,macb";
					#address-cells = <0x1>;
					#size-cells = <0x0>;
					reg = <0xc0 0x40100000 0x0 0x4000>;
					interrupts = <0x6 0x4>;
					phy-reset-duration = <0x5>;
					phy-reset-gpios = <&gpiod0000 0x20 0x1>;
					phy-handle = <0x4b>;
					local-mac-address = [00 00 00 00 00 00];
					cdns,use-aw2b-fill;
					cdns,ar2r-max-pipe = [08];
					cdns,aw2w-max-pipe = [08];
					phy-mode = "rgmii-id";
					clock-names = "pclk", "hclk", "tsu_clk";
					clocks = <&macb_pclk>, <&macb_hclk>, <&clocks18000 0x1d>;
					xen,path = "/axi/pcie@120000/rp1/ethernet@100000";
					xen,force-assign-without-iommu = <0x1>;
					xen,reg = <0xc0 0x40100000 0x0 0x4000 0xc0 0x40100000>;
					status = "okay";

					ethernet-phy@1 {
						reg = <0x1>;
						brcm,powerdown-enable;
					};
				};

				gpiod0000: gpio@c0400d0000 {
					compatible = "raspberrypi,rp1-gpio";
					#gpio-cells = <0x2>;
					gpio-controller;
					reg = <0xc0 0x400d0000 0x0 0xc000
					       0xc0 0x400e0000 0x0 0xc000
					       0xc0 0x400f0000 0x0 0xc000>;
					gpio-line-names = "ID_SDA", "ID_SCL", "GPIO2", "GPIO3",
							  "GPIO4", "GPIO5", "GPIO6", "GPIO7",
							  "GPIO8", "GPIO9", "GPIO10", "GPIO11",
							  "GPIO12", "GPIO13", "GPIO14", "GPIO15",
							  "GPIO16", "GPIO17", "GPIO18", "GPIO19",
							  "GPIO20", "GPIO21", "GPIO22", "GPIO23",
							  "GPIO24", "GPIO25", "GPIO26", "GPIO27",
							  "PCIE_RP1_WAKE", "FAN_TACH", "HOST_SDA",
							  "HOST_SCL", "ETH_RST_N", "-",
							  "CD0_IO0_MICCLK", "CD0_IO0_MICDAT0",
							  "RP1_PCIE_CLKREQ_N", "-", "CD0_SDA",
							  "CD0_SCL", "CD1_SDA", "CD1_SCL",
							  "USB_VBUS_EN", "USB_OC_N", "RP1_STAT_LED",
							  "FAN_PWM", "CD1_IO0_MICCLK", "2712_WAKE",
							  "CD1_IO1_MICDAT1", "EN_MAX_USB_CUR",
							  "-", "-", "-", "-";
					xen,path = "/axi/pcie@120000/rp1/gpio@d0000";
					xen,force-assign-without-iommu = <0x1>;
					xen,reg = <0xc0 0x400d0000 0x0 0xc000 0xc0 0x400d0000
						   0xc0 0x400e0000 0x0 0xc000 0xc0 0x400e0000
						   0xc0 0x400f0000 0x0 0xc000 0xc0 0x400f0000>;
					status = "okay";
				};

				clocks18000: clocks@c040018000 {
					compatible = "raspberrypi,rp1-clocks";
					#clock-cells = <0x1>;
					reg = <0xc0 0x40018000 0x0 0x10038>;
					clocks = <&clk_xosc>;
					assigned-clock-rates = <0x3b9aca00 0x5b8d8000 0xbebc200
								0x7735940 0x3a98000 0xb71b000
								0xbebc200 0x5f5e100 0x2faf080
								0xf4240 0xbebc200 0x2faf080>;
					assigned-clocks = <&clocks18000 0x0>, <&clocks18000 0x1>,
							  <&clocks18000 0x3>, <&clocks18000 0x9>,
							  <&clocks18000 0x4>, <&clocks18000 0xa>,
							  <&clocks18000 0xc>, <&clocks18000 0x6>,
							  <&clocks18000 0xd>, <&clocks18000 0x1f>,
							  <&clocks18000 0x20>, <&clocks18000 0x1d>;
					xen,path = "/axi/pcie@120000/rp1/clocks@18000";
					xen,force-assign-without-iommu = <0x1>;
					xen,reg = <0xc0 0x40018000 0x0 0x11000 0xc0 0x40018000>;
				};
			};
		};

		reset_controller1504318: reset-controller@1001504318 {
			compatible = "brcm,brcmstb-reset";
			#reset-cells = <0x1>;
			reg = <0x10 0x1504318 0x0 0x30>;
			xen,path = "/axi/reset-controller@1504318";
			xen,force-assign-without-iommu = <0x1>;
			xen,reg = <0x10 0x1504000 0x0 0x1000 0x10 0x1504000>;
		};

		reset_controller119500: reset-controller@1000119500 {
			compatible = "brcm,bcm7216-pcie-sata-rescal";
			#reset-cells = <0x0>;
			reg = <0x10 0x119500 0x0 0x10>;
			xen,path = "/axi/reset-controller@119500";
			xen,force-assign-without-iommu = <0x1>;
			xen,reg = <0x10 0x119000 0x0 0x1000 0x10 0x119000>;
		};
	};
};
